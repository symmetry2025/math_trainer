name: trainer (prod)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read
  packages: write

env:
  IMAGE: ghcr.io/${{ github.repository }}/trainer-standalone

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Promote from staging (fast path)
        id: promote
        run: |
          set -euo pipefail
          SRC="${{ env.IMAGE }}:staging-${GITHUB_SHA}"
          DST_TAG="${{ env.IMAGE }}:${GITHUB_REF_NAME}"
          DST_LATEST="${{ env.IMAGE }}:latest"

          if docker buildx imagetools inspect "$SRC" >/dev/null 2>&1; then
            echo "[prod] promote $SRC -> $DST_TAG, $DST_LATEST"
            docker buildx imagetools create -t "$DST_TAG" -t "$DST_LATEST" "$SRC"
            echo "promoted=1" >> "$GITHUB_OUTPUT"
          else
            echo "[prod] staging image not found for $GITHUB_SHA; fallback to build"
            echo "promoted=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Build & push (fallback)
        if: ${{ steps.promote.outputs.promoted != '1' }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE }}:${{ github.ref_name }}
            ${{ env.IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    # GitHub validates `if:` expressions and does not allow `secrets.*` here.
    # Control deploy via repository variable VPS_DEPLOY_ENABLED=1.
    if: ${{ vars.VPS_DEPLOY_ENABLED == '1' }}
    environment: prod
    steps:
      - name: Deploy to VPS (prod)
        uses: appleboy/ssh-action@v1.1.0
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
          WEB_BASE_URL: ${{ secrets.WEB_BASE_URL }}
          EMAIL_CONFIRM_TTL_HOURS: ${{ secrets.EMAIL_CONFIRM_TTL_HOURS }}
          MAX_BOT_TOKEN: ${{ secrets.MAX_BOT_TOKEN }}
          MAX_INITDATA_MAX_AGE_SEC: ${{ vars.MAX_INITDATA_MAX_AGE_SEC }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_INITDATA_MAX_AGE_SEC: ${{ vars.TELEGRAM_INITDATA_MAX_AGE_SEC }}
          NEXT_PUBLIC_TELEGRAM_BOT_USERNAME: ${{ vars.NEXT_PUBLIC_TELEGRAM_BOT_USERNAME }}
          CP_MODE: ${{ vars.CP_MODE }}
          BILLING_PRICE_RUB: ${{ vars.BILLING_PRICE_RUB }}
          CP_PUBLIC_ID: ${{ secrets.CP_PUBLIC_ID }}
          CP_API_SECRET: ${{ secrets.CP_API_SECRET }}
          CP_WEBHOOK_SECRET: ${{ secrets.CP_WEBHOOK_SECRET }}
          NEXT_PUBLIC_CP_PUBLIC_ID: ${{ secrets.NEXT_PUBLIC_CP_PUBLIC_ID }}
          CP_PUBLIC_ID_TEST: ${{ secrets.CP_PUBLIC_ID_TEST }}
          CP_API_SECRET_TEST: ${{ secrets.CP_API_SECRET_TEST }}
          CP_WEBHOOK_SECRET_TEST: ${{ secrets.CP_WEBHOOK_SECRET_TEST }}
          NEXT_PUBLIC_CP_PUBLIC_ID_TEST: ${{ secrets.NEXT_PUBLIC_CP_PUBLIC_ID_TEST }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          envs: SMTP_HOST,SMTP_PORT,SMTP_SECURE,SMTP_USER,SMTP_PASS,MAIL_FROM,WEB_BASE_URL,EMAIL_CONFIRM_TTL_HOURS,MAX_BOT_TOKEN,MAX_INITDATA_MAX_AGE_SEC,TELEGRAM_BOT_TOKEN,TELEGRAM_INITDATA_MAX_AGE_SEC,NEXT_PUBLIC_TELEGRAM_BOT_USERNAME,CP_MODE,BILLING_PRICE_RUB,CP_PUBLIC_ID,CP_API_SECRET,CP_WEBHOOK_SECRET,NEXT_PUBLIC_CP_PUBLIC_ID,CP_PUBLIC_ID_TEST,CP_API_SECRET_TEST,CP_WEBHOOK_SECRET_TEST,NEXT_PUBLIC_CP_PUBLIC_ID_TEST
          script: |
            set -euo pipefail
            cd /opt/math_trainer/prod
            ENV_FILE="./.env"

            sanitize_env_value() {
              # Replace CR/LF with spaces to avoid breaking .env format.
              local v="${1:-}"
              v="${v//$'\r'/ }"
              v="${v//$'\n'/ }"
              echo "$v"
            }

            clean_env_file_in_place() {
              local file="$1"
              [[ -f "$file" ]] || return 0
              # Keep only: empty lines, comments, KEY=VALUE lines. Drop everything else to avoid docker compose parse errors.
              awk '
                /^[[:space:]]*$/ { print; next }
                /^[[:space:]]*#/ { print; next }
                /^[A-Za-z_][A-Za-z0-9_]*=/ { print; next }
                { print "[deploy] dropped invalid .env line " NR > "/dev/stderr" }
              ' "$file" > "$file.__deploy_clean__"
              mv "$file.__deploy_clean__" "$file"
            }

            upsert_env_var() {
              local key="$1"
              local value="$2"
              local file="$3"
              value="$(sanitize_env_value "$value")"
              local esc="${value//\\/\\\\}"
              esc="${esc//\"/\\\"}"
              local line="${key}=\"${esc}\""
              local tmp
              tmp="$(mktemp)"
              if [[ -f "$file" ]]; then
                grep -vE "^${key}=" "$file" > "$tmp" || true
              fi
              printf "%s\n" "$line" >> "$tmp"
              mv "$tmp" "$file"
            }

            maybe_upsert_env_var() {
              local key="$1"
              local value="${2:-}"
              local file="$3"
              if [[ -z "$value" ]]; then
                echo "[deploy] skip $key (empty)"
                return 0
              fi
              upsert_env_var "$key" "$value" "$file"
            }

            touch "$ENV_FILE"
            chmod 600 "$ENV_FILE" || true
            clean_env_file_in_place "$ENV_FILE"

            maybe_upsert_env_var SMTP_HOST "${SMTP_HOST:-}" "$ENV_FILE"
            maybe_upsert_env_var SMTP_PORT "${SMTP_PORT:-}" "$ENV_FILE"
            maybe_upsert_env_var SMTP_SECURE "${SMTP_SECURE:-}" "$ENV_FILE"
            maybe_upsert_env_var SMTP_USER "${SMTP_USER:-}" "$ENV_FILE"
            maybe_upsert_env_var SMTP_PASS "${SMTP_PASS:-}" "$ENV_FILE"
            maybe_upsert_env_var MAIL_FROM "${MAIL_FROM:-}" "$ENV_FILE"
            maybe_upsert_env_var WEB_BASE_URL "${WEB_BASE_URL:-}" "$ENV_FILE"
            maybe_upsert_env_var EMAIL_CONFIRM_TTL_HOURS "${EMAIL_CONFIRM_TTL_HOURS:-}" "$ENV_FILE"
            maybe_upsert_env_var MAX_BOT_TOKEN "${MAX_BOT_TOKEN:-}" "$ENV_FILE"
            maybe_upsert_env_var MAX_INITDATA_MAX_AGE_SEC "${MAX_INITDATA_MAX_AGE_SEC:-}" "$ENV_FILE"
            maybe_upsert_env_var TELEGRAM_BOT_TOKEN "${TELEGRAM_BOT_TOKEN:-}" "$ENV_FILE"
            maybe_upsert_env_var TELEGRAM_INITDATA_MAX_AGE_SEC "${TELEGRAM_INITDATA_MAX_AGE_SEC:-}" "$ENV_FILE"
            maybe_upsert_env_var NEXT_PUBLIC_TELEGRAM_BOT_USERNAME "${NEXT_PUBLIC_TELEGRAM_BOT_USERNAME:-}" "$ENV_FILE"
            maybe_upsert_env_var CP_MODE "${CP_MODE:-}" "$ENV_FILE"
            maybe_upsert_env_var BILLING_PRICE_RUB "${BILLING_PRICE_RUB:-}" "$ENV_FILE"
            maybe_upsert_env_var CP_PUBLIC_ID "${CP_PUBLIC_ID:-}" "$ENV_FILE"
            maybe_upsert_env_var CP_API_SECRET "${CP_API_SECRET:-}" "$ENV_FILE"
            maybe_upsert_env_var CP_WEBHOOK_SECRET "${CP_WEBHOOK_SECRET:-}" "$ENV_FILE"
            maybe_upsert_env_var NEXT_PUBLIC_CP_PUBLIC_ID "${NEXT_PUBLIC_CP_PUBLIC_ID:-}" "$ENV_FILE"
            maybe_upsert_env_var CP_PUBLIC_ID_TEST "${CP_PUBLIC_ID_TEST:-}" "$ENV_FILE"
            maybe_upsert_env_var CP_API_SECRET_TEST "${CP_API_SECRET_TEST:-}" "$ENV_FILE"
            maybe_upsert_env_var CP_WEBHOOK_SECRET_TEST "${CP_WEBHOOK_SECRET_TEST:-}" "$ENV_FILE"
            maybe_upsert_env_var NEXT_PUBLIC_CP_PUBLIC_ID_TEST "${NEXT_PUBLIC_CP_PUBLIC_ID_TEST:-}" "$ENV_FILE"

            require_env_key() {
              local key="$1"
              local file="$2"
              if grep -qE "^${key}=" "$file"; then
                echo "[deploy] ok: $key is set"
                return 0
              fi
              echo "[deploy] missing: $key" >&2
              return 1
            }

            missing=0
            for k in SMTP_HOST SMTP_PORT SMTP_SECURE SMTP_USER SMTP_PASS MAIL_FROM; do
              require_env_key "$k" "$ENV_FILE" || missing=1
            done

            mode="${CP_MODE:-}"
            mode="$(echo "$mode" | tr -d '\r\n' | tr '[:upper:]' '[:lower:]')"
            if [[ "$mode" == "test" ]]; then
              for k in CP_PUBLIC_ID_TEST CP_API_SECRET_TEST NEXT_PUBLIC_CP_PUBLIC_ID_TEST; do
                require_env_key "$k" "$ENV_FILE" || missing=1
              done
            else
              for k in CP_PUBLIC_ID CP_API_SECRET NEXT_PUBLIC_CP_PUBLIC_ID; do
                require_env_key "$k" "$ENV_FILE" || missing=1
              done
            fi

            if [[ "$missing" -ne 0 ]]; then
              echo "[deploy] required env keys are missing in $ENV_FILE; abort deploy" >&2
              exit 1
            fi

            APP_TAG="${{ github.ref_name }}" docker compose -f compose.yml pull
            APP_TAG="${{ github.ref_name }}" docker compose -f compose.yml up -d --force-recreate app
            docker compose -f compose.yml ps

